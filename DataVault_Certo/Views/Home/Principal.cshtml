@using System.IO
@using System.Threading.Tasks
@using DataVault.Models.Composite

@functions {
    public async Task RenderNode(IFileComponent node)
    {
        if (node.ArquivoFile)
        {
            <div class="arquivo-item">
                <i class="fa-regular fa-file"></i>
                <span>@node.Nome</span>
                @if (node is FileLeaf leaf)
                {
                    <span>(@leaf.TipoArquivo)</span>
                }
                <a asp-controller="Files" asp-action="DownloadByName" asp-route-fileName="@node.Nome" class="btn-download">
                    <i class="fa-solid fa-download"></i>
                </a>
            </div>
        }
        else
        {
            <div class="pasta-item">
                <i class="fa-solid fa-folder"></i>
                <strong>@node.Nome</strong>
                <div class="pasta-filhos" style="margin-left:20px;">
                    @if (node.GetChildren() != null && node.GetChildren().Any())
                    {
                        foreach (var child in node.GetChildren())
                        {
                            await RenderNode(child);
                        }
                    }
                </div>
            </div>
        }
    }
}

@{
    ViewData["Title"] = "Principal";
    Layout = null;

    var nomeCliente = Context.Session.GetString("NomeCliente") ?? "Usuário";
}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/Principal.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
</head>
<body>
    <header>
        <div id="linha1">
            <div id="Empresa">
                <div><img src="~/imagens/logo.png" alt="Logo" id="Logo"></div>
                <div id="nomeEmpresa"><h3>DataVault</h3></div>
            </div>

            <div id="pesquisa">
                <form asp-controller="Files" asp-action="Search" method="post">
                    <div id="lupa">
                        <i class="fa-solid fa-magnifying-glass" id="lupinha"></i>
                        <input type="search" name="Procura" id="input_procurar" placeholder="Pesquise aqui" />
                    </div>
                </form>
            </div>

            <div id="tres_icones">
                <div id="premium"><i class="fa-solid fa-gem"></i></div>
                <div id="configuracoes">
                    <a asp-controller="Home" asp-action="Configuracoes"><i class="fa-solid fa-gear"></i></a>
                </div>
                <div id="perfil"><i class="fa-solid fa-user"></i></div>
            </div>
        </div>

        <div id="linha2">
            <div id="nome_cliente">
                <h3>@nomeCliente</h3>
            </div>
            <ul id="lista_tipos">
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo=""><h3>Recentes</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="pdf"><h3>PDF</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="excel"><h3>Excel</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="jpg"><h3>JPG</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="png"><h3>PNG</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="word"><h3>WORD</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="outros"><h3>Outros</h3></a></li>
            </ul>
        </div>
    </header>

    <div id="separar_dois">
        <nav>
            <div id="carregar">
                <h2 id="texto_carregar">
                    <i class="fa-solid fa-upload" id="icone_baixar"></i>
                    <span id="br_direita">Carregar</span>
                </h2>
                <form asp-controller="Files" asp-action="Upload" method="post" enctype="multipart/form-data" class="form-upload">
                    <input id="pular" type="file" name="arquivo" accept=".pdf,.pptx,.docx,.word,.xml,.png,.jpg,.sql,.txt" />
                </form>
            </div>

            <div id="lista_funcoes">
                <ul id="ul_funcoes">
                    <li id="pastas"><i class="fa-solid fa-folder"></i><div>Pastas</div></li>
                    <li id="favoritos"><i class="fa-solid fa-star"></i><div>Favoritos</div></li>
                    <li id="Compartilhados"><i class="fa-solid fa-share-nodes"></i><div>Compartilhados</div></li>
                    <li id="Lixeira"><i class="fa-solid fa-trash"></i><div>Lixeira</div></li>
                    <li id="deutrabalho"><i class="fa-solid fa-cloud"></i><div id="diminui_arma">Armazenamento</div></li>
                    <div id="memoria">5GB de 25GB</div>
                </ul>
            </div>
        </nav>

        <main>
            @{
                var arquivosRaiz = ViewBag.Arquivos as IEnumerable<DataVault.Models.Files> ?? new List<DataVault.Models.Files>();
                var pastasRaiz = arquivosRaiz.Where(f => f.IsPasta && f.PastaPaiId == null).ToList();
                var arquivosLivres = arquivosRaiz.Where(f => !f.IsPasta && f.PastaPaiId == null).ToList();
            }

            <div class="arquivos-lista" id="lista-arquivos">
                <!-- Pastas na raiz -->
                @foreach (var pasta in pastasRaiz)
                {
                    <div class="pasta-item" data-pasta-id="@pasta.Id" style="cursor: pointer; display: flex; align-items: center; margin: 8px 0;">
                        <i class="fa-solid fa-folder" style="color: #FFA500; margin-right: 10px;"></i>
                        <strong>@pasta.NomeArquivo</strong>
                        <span style="margin-left: 8px; color: #666;">(Pasta)</span>
                        <div class="conteudo-pasta" style="margin-left: 20px; display: none;"></div>
                    </div>
                }

                <!-- Arquivos soltos (sem pasta) -->
                @foreach (var arquivo in arquivosLivres)
                {
                    var suportaResumo = new[] { ".txt", ".pdf" }.Contains(arquivo.TipoArquivo.ToLower());
                    <div class="arquivo-item" style="display: flex; align-items: center; margin: 8px 0; padding-left: 10px; flex-wrap: wrap;">
                        <i class="fa-regular fa-file" style="margin-right: 10px;"></i>
                        <span>@arquivo.NomeArquivo</span>
                        @if (!string.IsNullOrEmpty(arquivo.TipoArquivo))
                        {
                            <span style="margin-left: 8px; color: #666;">(@arquivo.TipoArquivo)</span>
                        }

                        @if (suportaResumo)
                        {
                            <button class="btn-resumo-raiz" data-arquivo-id="@arquivo.Id"
                                    style="background: #e8f0fe; border: none; color: #1a73e8; cursor: pointer; font-size: 0.8em; padding: 2px 6px; margin-left: 10px; border-radius: 4px;">
                                <i class="fa-solid fa-comment"></i> Resumo
                            </button>
                        }

                        <a asp-controller="Files" asp-action="DownloadByName" asp-route-fileName="@arquivo.NomeArquivo" class="btn-download" style="margin-left: auto; text-decoration: none; color: #1a73e8;">
                            <i class="fa-solid fa-download"></i>
                        </a>
                        <div class="resumo-container-raiz" data-arquivo-id="@arquivo.Id" style="display: none; margin-top: 5px; background: #f8f9ff; padding: 8px; border-radius: 4px; font-size: 0.9em; width: 100%;"></div>
                        <!-- Dentro do foreach de arquivosLivres -->
                        @if (!string.IsNullOrEmpty(arquivo.Tags))
                        {
                            <div style="margin-top: 4px; font-size: 0.85em; display: flex; flex-wrap: wrap;">
                                @foreach (var tag in arquivo.Tags.Split(',').Where(t => !string.IsNullOrEmpty(t)))
                                {
                                    <span style="background: #e8f0fe; color: #1a73e8; padding: 2px 6px; border-radius: 4px; margin-right: 4px; margin-top: 2px;">
                                        #@tag
                                    </span>
                                }
                            </div>
                        }
                        else
                        {
                            <div style="margin-top: 4px; font-size: 0.85em; color: #888;">Sem tags</div>
                        }
                        @if (arquivo.ConteudoSensivel)
                        {
                            <div style="margin-top: 4px; font-size: 0.85em;">
                                <span style="background: #fff8e1; color: #e65100; padding: 2px 6px; border-radius: 4px;">
                                    ⚠️ Conteúdo Sensível
                                </span>
                            </div>
                        }
                    </div>
                }

                <script>
                    // Resumo para arquivos na raiz
                    document.querySelectorAll('.btn-resumo-raiz').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            const id = btn.getAttribute('data-arquivo-id');
                            const container = document.querySelector(`.resumo-container-raiz[data-arquivo-id="${id}"]`);

                            if (container.style.display === 'block') {
                                container.style.display = 'none';
                                btn.innerHTML = '<i class="fa-solid fa-comment"></i> Resumo';
                                return;
                            }

                            btn.disabled = true;
                            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Gerando...';

                            const res = await fetch(`/Files/ObterResumo?id=${id}`);
                            const data = await res.json();

                            if (data.erro) {
                                container.innerHTML = `<span style="color:red;">Erro: ${data.erro}</span>`;
                            } else {
                                container.innerHTML = `<strong>Resumo:</strong> ${data.resumo}`;
                            }

                            container.style.display = 'block';
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fa-solid fa-comment"></i> Ocultar';
                        });
                    });
                </script>
            </div>

            @if (!pastasRaiz.Any() && !arquivosLivres.Any())
            {
                <p style="text-align: center; color: #666; margin-top: 20px;">Nenhum arquivo encontrado.</p>
            }
        </main>

        <script>
            document.querySelectorAll('.pasta-item').forEach(pasta => {
                pasta.addEventListener('click', async function () {
                    const pastaId = this.getAttribute('data-pasta-id');
                    const conteudoDiv = this.querySelector('.conteudo-pasta');

                    if (conteudoDiv.innerHTML !== '') {
                        conteudoDiv.style.display = conteudoDiv.style.display === 'none' ? 'block' : 'none';
                        return;
                    }

                    const response = await fetch(`/Files/ObterArquivosDaPasta?pastaId=${pastaId}`);
                    const arquivos = await response.json();

                    if (arquivos.length === 0) {
                        conteudoDiv.innerHTML = '<span style="color:#888; font-style:italic;">Pasta vazia</span>';
                    } else {
                        let html = '';
                        arquivos.forEach(arq => {
                            const ext = arq.tipoArquivo.toLowerCase();
                            const suportaResumo = ['.txt', '.pdf'].includes(ext);

                            // Gera o HTML das tags
                            let tagsHtml = '';
                            if (arq.tags) {
                                const tags = arq.tags.split(',').filter(t => t.trim());
                                tags.forEach(tag => {
                                    tagsHtml += `<span style="background: #e8f0fe; color: #1a73e8; padding: 2px 6px; border-radius: 4px; margin-right: 4px; margin-top: 2px;">#${tag}</span>`;
                                });
                            }
                            let sensivelHtml = '';
                            if (arq.conteudoSensivel) {
                                sensivelHtml = `<div style="margin-top: 4px; font-size: 0.85em;">
                    <span style="background: #fff8e1; color: #e65100; padding: 2px 6px; border-radius: 4px;">⚠️ Conteúdo Sensível</span>
                </div>`;
                            }

                            html += `
                    <div class="arquivo-item" style="display: flex; align-items: center; margin: 6px 0; padding-left: 10px; flex-wrap: wrap;">
                        <i class="fa-regular fa-file" style="margin-right: 10px;"></i>
                        <span>${arq.nomeArquivo}</span>
                        <span style="margin-left: 8px; color: #666;">(${arq.tipoArquivo})</span>`;

                            if (suportaResumo) {
                                html += `
                        <button class="btn-resumo" data-arquivo-id="${arq.id}"
                                style="background: #e8f0fe; border: none; color: #1a73e8; cursor: pointer; font-size: 0.8em; padding: 2px 6px; margin-left: 10px; border-radius: 4px;">
                            <i class="fa-solid fa-comment"></i> Resumo
                        </button>`;
                            }

                            html += `
                        <a href="/Files/DownloadByName?fileName=${encodeURIComponent(arq.nomeArquivo)}"
                           class="btn-download" style="margin-left: auto; text-decoration: none; color: #1a73e8;">
                            <i class="fa-solid fa-download"></i>
                        </a>
                                    <div class="resumo-container" data-arquivo-id="${arq.id}" style="display: none; margin-top: 5px; background: #f8f9ff; padding: 8px; border-radius: 4px; font-size: 0.9em; width: 100%;"></div>
                    ${tagsHtml ? `<div style="margin-top: 4px; font-size: 0.85em; display: flex; flex-wrap: wrap;">${tagsHtml}</div>` : ''}
                    ${sensivelHtml}
                </div>`;

                        });
                        conteudoDiv.innerHTML = html;

                        // Adiciona evento aos botões de resumo
                        conteudoDiv.querySelectorAll('.btn-resumo').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                e.preventDefault();
                                const id = btn.getAttribute('data-arquivo-id');
                                const container = conteudoDiv.querySelector(`.resumo-container[data-arquivo-id="${id}"]`);

                                if (container.style.display === 'block') {
                                    container.style.display = 'none';
                                    btn.innerHTML = '<i class="fa-solid fa-comment"></i> Resumo';
                                    return;
                                }

                                btn.disabled = true;
                                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Gerando...';

                                const res = await fetch(`/Files/ObterResumo?id=${id}`);
                                const data = await res.json();

                                if (data.erro) {
                                    container.innerHTML = `<span style="color:red;">Erro: ${data.erro}</span>`;
                                } else {
                                    container.innerHTML = `<strong>Resumo:</strong> ${data.resumo}`;
                                }

                                container.style.display = 'block';
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fa-solid fa-comment"></i> Ocultar';
                            });
                        });
                    }
                    conteudoDiv.style.display = 'block';
                });
            });
        </script>
    </div>

    <script>
        const inputArquivo = document.querySelector('#pular');
        const form = document.querySelector('.form-upload');

        inputArquivo.addEventListener('change', () => {
            const formData = new FormData(form);

            fetch('/Files/Upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    location.reload();
                })
                .catch(error => alert('Erro ao enviar arquivo: ' + error));
        });
    </script>
</body>
</html>