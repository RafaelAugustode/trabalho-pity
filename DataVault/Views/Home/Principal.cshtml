@using System.IO
@using System.Threading.Tasks
@using DataVault.Models.Composite

@{
    ViewData["Title"] = "Principal";
    Layout = null;

    var nomeCliente = Context.Session.GetString("NomeCliente") ?? "Usuário";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/Principal.css?v=@DateTime.Now.Ticks" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <script src="~/js/Principal.js?v=@DateTime.Now.Ticks"></script>
</head>
<script>
    const idiomaAtual = '@(ViewBag.Lingua ?? "pt")';
</script>
    <body class="@(ViewBag.ModoSite?.Equals("Escuro", StringComparison.OrdinalIgnoreCase) == true ? "tema-escuro" : "")">
    <header>
        <div id="linha1">
            <div id="Empresa">
                @if(ViewBag.ModoSite == "Claro" )
                {
                    <div><img src="~/imagens/logo.png" alt="Logo" id="Logo"></div>
                }
                else if (ViewBag.ModoSite == "Escuro")
                {
                    <div><img src="~/imagens/Logo_Escuro.png" alt="Logo" id="Logo"></div>
                }
                else
                {
                    <div><img src="~/imagens/logo.png" alt="Logo" id="Logo"></div>
                }
                <div id="nomeEmpresa"><h3>DataVault</h3></div>
            </div>

            <div id="pesquisa">
                <form asp-controller="Files" asp-action="Search" method="post">
                    <div id="lupa">
                        <i class="fa-solid fa-magnifying-glass" id="lupinha"></i>
                        <input type="search" name="Procura" id="input_procurar" placeholder="Pesquise aqui" />
                    </div>
                </form>
            </div>

            <div id="tres_icones">
                <div id="premium"><i class="fa-solid fa-gem"></i></div>
                <div id="configuracoes">
                    <a asp-controller="Home" asp-action="Configuracoes"><i class="fa-solid fa-gear"></i></a>
                </div>
                <div id="perfil"><i class="fa-solid fa-user"></i></div>
            </div>
        </div>

        <div id="linha2">
            <div id="nome_cliente">
                <h3>@nomeCliente</h3>
            </div>
            <ul id="lista_tipos">
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo=""><h3 data-i18n="Recentes">Recentes</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="pdf"><h3>PDF</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="excel"><h3>Excel</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="jpg"><h3>JPG</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="png"><h3>PNG</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="word"><h3>WORD</h3></a></li>
                <li><a asp-controller="Files" asp-action="Filter" asp-route-tipo="outros"><h3 data-i18n="Outros">Outros</h3></a></li>
            </ul>
        </div>
    </header>

    <div id="separar_dois">
        <nav>
            <div id="carregar">
                <h2 id="texto_carregar">
                    <i class="fa-solid fa-upload" id="icone_baixar"></i>
                    <span id="br_direita" data-i18n="Carregar">Carregar</span>
                </h2>
                <form asp-controller="Files" asp-action="Upload" method="post" enctype="multipart/form-data" class="form-upload">
                    <input id="pular" type="file" name="arquivo" accept=".pdf,.pptx,.docx,.word,.xml,.png,.jpg,.sql,.txt" />
                </form>
            </div>

            <div id="lista_funcoes">
                <ul id="ul_funcoes">
                    <li id="pastas">
                        <a asp-controller="Files" asp-action="Pastas">
                            <i class="fa-solid fa-folder"></i><span data-i18n="Pastas">Pastas</span>
                        </a>
                    </li>
                    <li id="favoritos">
                        <a asp-controller="Files" asp-action="Favoritos">
                            <i class="fa-solid fa-star"></i><span data-i18n="favoritos">Favoritos</span>
                        </a>
                    </li>
                    <li id="Compartilhados">
                        <a asp-controller="Files" asp-action="Compartilhados">
                            <i class="fa-solid fa-share-nodes"></i><span data-i18n="Compartilhados">Compartilhados</span>
                        </a>
                    </li>
                    <li id="Lixeira">
                        <a asp-controller="Files" asp-action="Lixeira">
                            <i class="fa-solid fa-trash"></i><span data-i18n="Lixeira">Lixeira</span>
                        </a>
                    </li>
                    <li id="deutrabalho"><i class="fa-solid fa-cloud"></i><div id="diminui_arma" data-i18n="Armazenamento">Armazenamento</div></li>
                    @{
                        var espacoUsado = ViewBag.EspacoUsado ?? 0L;
                        string FormatarBytes(long bytes)
                        {
                            if (bytes < 1024) return $"{bytes} B";
                            if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
                            if (bytes < 1024 * 1024 * 1024) return $"{bytes / (1024.0 * 1024):F1} MB";
                            return $"{bytes / (1024.0 * 1024 * 1024):F1} GB";
                        }
                    }
                    <div id="memoria">@FormatarBytes(espacoUsado) de 25 GB</div>
                </ul>
            </div>
        </nav>

        <main>
            @{
                var arquivos = ViewBag.Arquivos as IEnumerable<DataVault.Models.Files> ?? new List<DataVault.Models.Files>();
                bool ehPesquisa = ViewBag.EhPesquisa == true;
                bool ehFiltro = ViewBag.EhFiltro == true;
                bool ehPastas = ViewBag.EhPastas == true;
                bool ehFavoritos = ViewBag.EhFavoritos == true;
                bool ehCompartilhados = ViewBag.EhCompartilhados == true;
                bool ehLixeira = ViewBag.EhLixeira == true;
                bool ehModoEspecial = ehPesquisa || ehFiltro || ehFavoritos || ehCompartilhados || ehLixeira;
            }

            @if (ehModoEspecial)
            {
                <div class="arquivos-lista">
                    @if (arquivos.Any(f => !f.IsPasta))
                    {
                        @foreach (var arquivo in arquivos.Where(f => !f.IsPasta).OrderBy(f => f.NomeArquivo))
                        {
                            var suportaResumo = new[] { ".txt", ".pdf", ".docx", ".pptx", ".xml", ".sql", ".jpg", ".jpeg", ".png", ".word" }
                            .Contains(arquivo.TipoArquivo.ToLower());
                            <div class="arquivo-item" style="display: flex; align-items: center; margin: 8px 0; padding: 0 30px 0 10px; position: relative; flex-wrap: wrap;">
                                <i class="fa-regular fa-file" style="margin-right: 10px;"></i>
                                <span id="nome_pasta">@arquivo.NomeArquivo</span>
                                @if (!string.IsNullOrEmpty(arquivo.TipoArquivo))
                                {
                                    <span style="margin-left: 8px; color: #666;">(@arquivo.TipoArquivo)</span>
                                }

                                <!-- Ícones de ação -->
                                <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px;">
                                    <form asp-controller="Files" asp-action="ToggleFavorito" method="post" style="margin:0;">
                                        <input type="hidden" name="id" value="@arquivo.Id" />
                                        <button type="submit" style="background:none; border:none; cursor:pointer; color: @(arquivo.Favorito ? "#FFD700" : "#ccc"); font-size:1.2em;">
                                            <i class="fa-solid fa-star"></i>
                                        </button>
                                    </form>
                                    <form asp-controller="Files" asp-action="ToggleCompartilhado" method="post" style="margin:0;">
                                        <input type="hidden" name="id" value="@arquivo.Id" />
                                        <button type="submit" style="background:none; border:none; cursor:pointer; color: @(arquivo.Compartilhado ? "#4285F4" : "#ccc"); font-size:1.2em;">
                                            <i class="fa-solid fa-share-nodes"></i>
                                        </button>
                                    </form>
                                    <form asp-controller="Files" asp-action="Excluir" method="post" style="margin:0;" onsubmit="return confirm('Mover para a lixeira?');">
                                        <input type="hidden" name="id" value="@arquivo.Id" />
                                        <button type="submit" style="background:none; border:none; cursor:pointer; color:#e65100; font-size:1.2em;">
                                            <i class="fa-solid fa-trash"></i>
                                        </button>
                                    </form>
                                </div>

                                @if (suportaResumo)
                                {
                                    <button class="btn-resumo-raiz" data-arquivo-id="@arquivo.Id"
                                            style="background: #e8f0fe; border: none; color: #1a73e8; cursor: pointer; font-size: 0.8em; padding: 2px 6px; margin-left: 10px; border-radius: 4px;">
                                        <i class="fa-solid fa-comment"></i> Resumo
                                    </button>
                                }

                                @if (!string.IsNullOrEmpty(arquivo.Tags))
                                {
                                    <div style="margin-top: 4px; font-size: 0.85em; display: flex; flex-wrap: wrap; width: 100%;">
                                        @foreach (var tag in arquivo.Tags.Split(',').Where(t => !string.IsNullOrEmpty(t)))
                                        {
                                            <span style="background: #e8f0fe; color: #1a73e8; padding: 2px 6px; border-radius: 4px; margin-right: 4px; margin-top: 2px;">#@tag</span>
                                        }
                                    </div>
                                }

                                @if (arquivo.ConteudoSensivel)
                                {
                                    <div style="margin-top: 4px; font-size: 0.85em;">
                                        <span style="background: #fff8e1; color: #e65100; padding: 2px 6px; border-radius: 4px;">⚠️ Conteúdo Sensível</span>
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <p style="text-align: center; color: #666; margin-top: 20px;">Nenhum arquivo encontrado.</p>
                    }
                </div>
            }
            else if (ehPastas)
            {
                <div class="arquivos-lista">
                    @if (arquivos.Any(f => f.IsPasta))
                    {
                        @foreach (var pasta in arquivos.Where(f => f.IsPasta).OrderBy(f => f.NomeArquivo))
                        {
                            <div class="pasta-item" data-pasta-id="@pasta.Id" style="cursor: pointer; display: flex; align-items: center; margin: 8px 0;">
                                <i class="fa-solid fa-folder" style="color: #FFA500; margin-right: 10px;"></i>
                                <strong id="nome_pasta">@pasta.NomeArquivo</strong>
                                <span style="margin-left: 8px; color: #666;">(Pasta)</span>
                                <div class="conteudo-pasta" style="margin-left: 20px; display: none;"></div>
                            </div>
                        }
                    }
                    else
                    {
                        <p style="text-align: center; color: #666; margin-top: 20px;">Nenhuma pasta encontrada.</p>
                    }
                </div>
            }
            else
            {
                var pastasRaiz = arquivos.Where(f => f.IsPasta && f.PastaPaiId == null).ToList();
                var arquivosLivres = arquivos.Where(f => !f.IsPasta && f.PastaPaiId == null).ToList();

                <div class="arquivos-lista" id="lista-arquivos">
                    @foreach (var pasta in pastasRaiz)
                    {
                        <div class="pasta-item" data-pasta-id="@pasta.Id" style="cursor: pointer; display: flex; align-items: center; margin: 8px 0;">
                            <i class="fa-solid fa-folder" style="color: #FFA500; margin-right: 10px;"></i>
                            <strong id="nome_pasta">@pasta.NomeArquivo</strong>
                            <span style="margin-left: 8px; color: #666;">(Pasta)</span>
                            <div class="conteudo-pasta" style="margin-left: 20px; display: none;"></div>
                        </div>
                    }
                    @foreach (var arquivo in arquivosLivres)
                    {
                        var suportaResumo = new[] { ".txt", ".pdf", ".docx", ".pptx", ".xml", ".sql", ".jpg", ".jpeg", ".png", ".word" }
                        .Contains(arquivo.TipoArquivo.ToLower());
                        <div class="arquivo-item" style="display: flex; align-items: center; margin: 8px 0; padding: 0 30px 0 10px; position: relative; flex-wrap: wrap;">
                            <i class="fa-regular fa-file" style="margin-right: 10px;"></i>
                            <span id="nome_pasta">@arquivo.NomeArquivo</span>
                            @if (!string.IsNullOrEmpty(arquivo.TipoArquivo))
                            {
                                <span style="margin-left: 8px; color: #666;">(@arquivo.TipoArquivo)</span>
                            }

                            <!-- Ícones de ação -->
                            <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px;">
                                <form asp-controller="Files" asp-action="ToggleFavorito" method="post" style="margin:0;">
                                    <input type="hidden" name="id" value="@arquivo.Id" />
                                    <button type="submit" style="background:none; border:none; cursor:pointer; color: @(arquivo.Favorito ? "#FFD700" : "#ccc"); font-size:1.2em;">
                                        <i class="fa-solid fa-star"></i>
                                    </button>
                                </form>
                                <form asp-controller="Files" asp-action="ToggleCompartilhado" method="post" style="margin:0;">
                                    <input type="hidden" name="id" value="@arquivo.Id" />
                                    <button type="submit" style="background:none; border:none; cursor:pointer; color: @(arquivo.Compartilhado ? "#4285F4" : "#ccc"); font-size:1.2em;">
                                        <i class="fa-solid fa-share-nodes"></i>
                                    </button>
                                </form>
                                <form asp-controller="Files" asp-action="Excluir" method="post" style="margin:0;" onsubmit="return confirm('Mover para a lixeira?');">
                                    <input type="hidden" name="id" value="@arquivo.Id" />
                                    <button type="submit" style="background:none; border:none; cursor:pointer; color:#e65100; font-size:1.2em;">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </form>
                            </div>

                            @if (suportaResumo)
                            {
                                <button class="btn-resumo-raiz" data-arquivo-id="@arquivo.Id"
                                        style="background: #e8f0fe; border: none; color: #1a73e8; cursor: pointer; font-size: 0.8em; padding: 2px 6px; margin-left: 10px; border-radius: 4px;">
                                    <i class="fa-solid fa-comment"></i> Resumo
                                </button>
                            }

                            @if (!string.IsNullOrEmpty(arquivo.Tags))
                            {
                                <div style="margin-top: 4px; font-size: 0.85em; display: flex; flex-wrap: wrap; width: 100%;">
                                    @foreach (var tag in arquivo.Tags.Split(',').Where(t => !string.IsNullOrEmpty(t)))
                                    {
                                        <span style="background: #e8f0fe; color: #1a73e8; padding: 2px 6px; border-radius: 4px; margin-right: 4px; margin-top: 2px;">#@tag</span>
                                    }
                                </div>
                            }
                            else
                            {
                                <div style="margin-top: 4px; font-size: 0.85em; color: #888;">Sem tags</div>
                            }

                            @if (arquivo.ConteudoSensivel)
                            {
                                <div style="margin-top: 4px; font-size: 0.85em;">
                                    <span style="background: #fff8e1; color: #e65100; padding: 2px 6px; border-radius: 4px;">⚠️ Conteúdo Sensível</span>
                                </div>
                            }
                        </div>
                    }
                </div>

                @if (!pastasRaiz.Any() && !arquivosLivres.Any())
                {
                    <p style="text-align: center; color: #666; margin-top: 20px;">Nenhum arquivo encontrado.</p>
                }
            }
        </main>

        <script>
            document.querySelectorAll('.pasta-item').forEach(pasta => {
                pasta.addEventListener('click', async function () {
                    const pastaId = this.getAttribute('data-pasta-id');
                    const conteudoDiv = this.querySelector('.conteudo-pasta');

                    if (conteudoDiv.innerHTML !== '') {
                        conteudoDiv.style.display = conteudoDiv.style.display === 'none' ? 'block' : 'none';
                        return;
                    }

                    const response = await fetch(`/Files/ObterArquivosDaPasta?pastaId=${pastaId}`);
                    const arquivos = await response.json();

                    if (arquivos.length === 0) {
                        conteudoDiv.innerHTML = '<span style="color:#888; font-style:italic;">Pasta vazia</span>';
                    } else {
                        let html = '';
                        arquivos.forEach(arq => {
                            const ext = arq.tipoArquivo.toLowerCase();
                            const suportaResumo = ['.txt', '.pdf', '.docx', '.pptx', '.xml', '.sql', '.jpg', '.jpeg', '.png', '.word'].includes(ext);

                            let tagsHtml = '';
                            if (arq.tags) {
                                const tags = arq.tags.split(',').filter(t => t.trim());
                                tags.forEach(tag => {
                                    tagsHtml += `<span style="background: #e8f0fe; color: #1a73e8; padding: 2px 6px; border-radius: 4px; margin-right: 4px; margin-top: 2px;">#${tag}</span>`;
                                });
                            }

                            let sensivelHtml = '';
                            if (arq.conteudoSensivel) {
                                sensivelHtml = `<div style="margin-top: 4px; font-size: 0.85em;"><span style="background: #fff8e1; color: #e65100; padding: 2px 6px; border-radius: 4px;">⚠️ Conteúdo Sensível</span></div>`;
                            }

                            // Ícones de ação para arquivos dentro de pastas
                            let iconesAcao = `
                                            <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; gap: 8px;">
                                                <form action="/Files/ToggleFavorito" method="post" style="margin:0;">
                                                    <input type="hidden" name="id" value="${arq.id}" />
                                                    <button type="submit" style="background:none; border:none; cursor:pointer; color: ${arq.favorito ? "#FFD700" : "#ccc"}; font-size:1.2em;">
                                                        <i class="fa-solid fa-star"></i>
                                                    </button>
                                                </form>
                                                <form action="/Files/ToggleCompartilhado" method="post" style="margin:0;">
                                                    <input type="hidden" name="id" value="${arq.id}" />
                                                    <button type="submit" style="background:none; border:none; cursor:pointer; color: ${arq.compartilhado ? "#4285F4" : "#ccc"}; font-size:1.2em;">
                                                        <i class="fa-solid fa-share-nodes"></i>
                                                    </button>
                                                </form>
                                                <form action="/Files/Excluir" method="post" style="margin:0;" onsubmit="return confirm('Mover para a lixeira?');">
                                                    <input type="hidden" name="id" value="${arq.id}" />
                                                    <button type="submit" style="background:none; border:none; cursor:pointer; color:#e65100; font-size:1.2em;">
                                                        <i class="fa-solid fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        `;

                            html += `
                                            <div class="arquivo-item" style="display: flex; align-items: center; margin: 6px 0; padding: 0 30px 0 10px; position: relative; flex-wrap: wrap;">
                                                <i class="fa-regular fa-file" style="margin-right: 10px;"></i>
                                                <span id="nome_pasta">${arq.nomeArquivo}</span>
                                                <span style="margin-left: 8px; color: #666;">(${arq.tipoArquivo})</span>`;

                            if (suportaResumo) {
                                html += `
                                                <button class="btn-resumo" data-arquivo-id="${arq.id}"
                                                        style="background: #e8f0fe; border: none; color: #1a73e8; cursor: pointer; font-size: 0.8em; padding: 2px 6px; margin-left: 10px; border-radius: 4px;">
                                                    <i class="fa-solid fa-comment"></i> Resumo
                                                </button>`;
                            }

                            html += iconesAcao;
                            html += `
                                            <div class="resumo-container" data-arquivo-id="${arq.id}" style="display: none; margin-top: 5px; background: #f8f9ff; padding: 8px; border-radius: 4px; font-size: 0.9em; width: 100%;"></div>
                                            ${tagsHtml ? `<div style="margin-top: 4px; font-size: 0.85em; display: flex; flex-wrap: wrap;">${tagsHtml}</div>` : ''}
                                            ${sensivelHtml}
                                            </div>`;
                        });
                        conteudoDiv.innerHTML = html;

                        // Adiciona evento aos botões de resumo dentro de pastas
                        conteudoDiv.querySelectorAll('.btn-resumo').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                e.preventDefault();
                                const id = btn.getAttribute('data-arquivo-id');
                                const container = conteudoDiv.querySelector(`.resumo-container[data-arquivo-id="${id}"]`);

                                if (container.style.display === 'block') {
                                    container.style.display = 'none';
                                    btn.innerHTML = '<i class="fa-solid fa-comment"></i> Resumo';
                                    return;
                                }

                                btn.disabled = true;
                                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Gerando...';

                                const res = await fetch(`/Files/ObterResumo?id=${id}`);
                                const data = await res.json();

                                if (data.erro) {
                                    container.innerHTML = `<span style="color:red;">Erro: ${data.erro}</span>`;
                                } else {
                                    container.innerHTML = `<strong>Resumo:</strong> ${data.resumo}`;
                                }

                                container.style.display = 'block';
                                btn.disabled = false;
                                btn.innerHTML = '<i class="fa-solid fa-comment"></i> Ocultar';
                            });
                        });
                    }
                    conteudoDiv.style.display = 'block';
                });
            });
        </script>
    </div>

    <script>
        const inputArquivo = document.querySelector('#pular');
        const form = document.querySelector('.form-upload');

        inputArquivo.addEventListener('change', () => {
            const formData = new FormData(form);

            fetch('/Files/Upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.text())
                .then(result => {
                    alert(result);
                    location.reload();
                })
                .catch(error => alert('Erro ao enviar arquivo: ' + error));
        });
    </script>
    <script>
        // Aplica o idioma ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            const lingua = '@(ViewBag.Lingua ?? "pt")';
            if (traducoes[lingua]) {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const chave = el.getAttribute('data-i18n');
                    if (traducoes[lingua][chave]) {
                        el.textContent = traducoes[lingua][chave];
                    }
                });
            }
        });
    </script>
</body>
</html>